--// SERVICES
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

--// ANIMATION CONFIG
local TARGET_ANIM_ID = "rbxassetid://95421145178968"      -- Disabled original
local REPLACEMENT_ANIM_ID = "rbxassetid://76313364850487" -- Replacement

-- Default segment
local DEFAULT_START = 0
local DEFAULT_DURATION = 4

-- Low-HP segment
local LOW_HP_START = 5.3
local LOW_HP_DURATION = 20
local LOW_HP_THRESHOLD = 0.10 -- 10%

local COOLDOWN_TIME = 4 -- seconds

--// STATE
local onCooldown = false
local stopConn = nil
local ReplacementTrack = nil

-- Function to find nearest valid humanoid
local function getNearestHumanoid(rootPart)
    local nearestHumanoid = nil
    local shortestDist = math.huge

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local char = player.Character
            if char then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                local hum = char:FindFirstChild("Humanoid")
                if hrp and hum and hum.Health > 0 then
                    local dist = (hrp.Position - rootPart.Position).Magnitude
                    if dist < shortestDist then
                        shortestDist = dist
                        nearestHumanoid = hum
                    end
                end
            end
        end
    end

    return nearestHumanoid
end

-- Function to play replacement animation
local function playReplacement(track, humanoid, rootPart)
    if onCooldown then return end
    onCooldown = true

    local startTime = DEFAULT_START
    local duration = DEFAULT_DURATION

    -- Low HP check
    local nearestHumanoid = getNearestHumanoid(rootPart)
    if nearestHumanoid then
        if (nearestHumanoid.Health / nearestHumanoid.MaxHealth) <= LOW_HP_THRESHOLD then
            startTime = LOW_HP_START
            duration = LOW_HP_DURATION
        end
    end

    -- Stop previous track safely
    if ReplacementTrack then
        ReplacementTrack:Stop()
    end

    -- Load new track if necessary
    if not ReplacementTrack then
        local anim = Instance.new("Animation")
        anim.AnimationId = REPLACEMENT_ANIM_ID
        ReplacementTrack = humanoid:LoadAnimation(anim)
        ReplacementTrack.Looped = false
    end

    ReplacementTrack.TimePosition = startTime
    ReplacementTrack:Play()

    -- Stop replacement if original stops
    if stopConn then stopConn:Disconnect() end
    stopConn = track.Stopped:Connect(function()
        ReplacementTrack:Stop()
    end)

    -- Stop after duration
    task.delay(duration, function()
        ReplacementTrack:Stop()
    end)

    -- Cooldown
    task.delay(duration + COOLDOWN_TIME, function()
        onCooldown = false
    end)
end

-- Setup function for each character
local function setupCharacter(character)
    local humanoid = character:WaitForChild("Humanoid")
    local rootPart = character:WaitForChild("HumanoidRootPart")

    humanoid.AnimationPlayed:Connect(function(track)
        if track.Animation.AnimationId == TARGET_ANIM_ID then
            -- Disable original animation
            if track.IsPlaying then
                track:Stop()
            end

            -- Play replacement
            playReplacement(track, humanoid, rootPart)
        end
    end)
end

-- Initial setup
if LocalPlayer.Character then
    setupCharacter(LocalPlayer.Character)
end

-- Reconnect on respawn
LocalPlayer.CharacterAdded:Connect(function(character)
    setupCharacter(character)
end)

-- New script

--// SERVICES
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer

--// ANIMATION DATA
local ANIM_A_ID = "rbxassetid://137865634124104"
local ANIM_A_DURATION = 0.8

local ANIM_B_ID = "rbxassetid://104749346956269"
local ANIM_B_START = 2.3
local ANIM_B_DURATION = 1

--// LEVITATION DATA
local LEVITATE_HEIGHT = 10 -- studs
local LEVITATE_DURATION = 1 -- seconds to rise

--// STATE
local sequenceRunning = false
local cooldown = false
local COOLDOWN_TIME = 4 -- seconds

--// PRELOAD ANIMATIONS (reuse objects to reduce lag)
local animations = {}
animations.A = Instance.new("Animation")
animations.A.AnimationId = ANIM_A_ID

animations.B = Instance.new("Animation")
animations.B.AnimationId = ANIM_B_ID

--// FUNCTION TO PLAY ANIMATION
local function playAnimation(humanoid, animObject, fadeTime, weight)
	local animator = humanoid:FindFirstChildWhichIsA("Animator")
	if not animator then
		animator = Instance.new("Animator")
		animator.Parent = humanoid
	end

	local track = animator:LoadAnimation(animObject)
	track:Play(fadeTime or 0.1, weight or 1, 1)
	return track
end

--// STOP ALL ANIMATION A TRACKS
local function stopAllATracks(humanoid)
	local animator = humanoid:FindFirstChildWhichIsA("Animator")
	if animator then
		for _, track in ipairs(animator:GetPlayingAnimationTracks()) do
			if track.Animation and track.Animation.AnimationId == ANIM_A_ID then
				track:Stop()
			end
		end
	end
end

--// SMOOTH LEVITATION USING TWEEN
local function levitatePlayerTween(character, height, duration, callback)
	local hrp = character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	-- Remove existing BodyPosition
	if hrp:FindFirstChild("LevitateBP") then
		hrp.LevitateBP:Destroy()
	end

	local startPos = hrp.Position
	local targetPos = startPos + Vector3.new(0, height, 0)

	local bp = Instance.new("BodyPosition")
	bp.Name = "LevitateBP"
	bp.MaxForce = Vector3.new(1e5,1e5,1e5)
	bp.Position = startPos
	bp.P = 1e4
	bp.D = 500
	bp.Parent = hrp

	local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
	local tween = TweenService:Create(bp, tweenInfo, {Position = targetPos})
	tween:Play()

	tween.Completed:Connect(function()
		bp:Destroy() -- Let gravity handle falling
		if callback then callback() end
	end)
end

--// RUN CONTROLLED SEQUENCE
local function runSequence(humanoid, trackA)
	if sequenceRunning or cooldown then return end
	sequenceRunning = true
	cooldown = true

	-- Let A play for its duration
	task.delay(ANIM_A_DURATION, function()
		if trackA and trackA.IsPlaying then
			trackA:Stop()
		end

		stopAllATracks(humanoid)

		local character = humanoid.Parent
		if not character then
			sequenceRunning = false
			return
		end

		-- Play Animation B starting at 2.3s
		local trackB = playAnimation(humanoid, animations.B)
		trackB.TimePosition = ANIM_B_START

		-- Smooth rise at start of B using Tween
		levitatePlayerTween(character, LEVITATE_HEIGHT, LEVITATE_DURATION, function()
			-- Stop B after duration
			task.delay(ANIM_B_DURATION, function()
				if trackB and trackB.IsPlaying then
					trackB:Stop()
				end
				sequenceRunning = false
			end)
		end)
	end)

	-- Start cooldown timer
	task.delay(COOLDOWN_TIME, function()
		cooldown = false
	end)
end

--// DETECT ORIGINAL ANIMATION A
local function detectAnimationA(character)
	local humanoid = character:WaitForChild("Humanoid")
	local animator = humanoid:WaitForChild("Animator")

	animator.AnimationPlayed:Connect(function(track)
		if not track.Animation then return end
		if track.Animation.AnimationId == ANIM_A_ID then
			if not sequenceRunning and not cooldown then
				runSequence(humanoid, track)
			end
		end
	end)
end

--// CHARACTER HANDLING
player.CharacterAdded:Connect(detectAnimationA)
if player.Character then
	detectAnimationA(player.Character)
end

-- last script

-- Services
local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- Animation IDs
local originalAnimId = "rbxassetid://110978068388232"
local replacementAnimId = "rbxassetid://86430725083594"
local replacementStart = 0.3
local replacementDuration = 1.1

-- Function to handle humanoid animations
local function setupHumanoid(humanoid)
    -- Cache replacement animation for this humanoid
    local replacementAnim = Instance.new("Animation")
    replacementAnim.AnimationId = replacementAnimId
    local replacementTrack = humanoid:LoadAnimation(replacementAnim)

    local function onTrackPlayed(track)
        if track.Animation.AnimationId == originalAnimId then
            -- Stop and disable the original
            track:Stop()
            track:Destroy()

            -- Play replacement animation segment
            replacementTrack.TimePosition = replacementStart
            replacementTrack:Play()

            -- Stop after the replacement duration
            task.spawn(function()
                local startTime = tick()
                while tick() - startTime < replacementDuration and replacementTrack.IsPlaying do
                    task.wait()
                end
                if replacementTrack.IsPlaying then
                    replacementTrack:Stop()
                end
            end)
        end
    end

    humanoid.AnimationPlayed:Connect(onTrackPlayed)
end

-- Function to handle character spawn
local function onCharacterAdded(character)
    local humanoid = character:WaitForChild("Humanoid")
    setupHumanoid(humanoid)
end

-- Connect for current character
if player.Character then
    onCharacterAdded(player.Character)
end

-- Connect for future respawns
player.CharacterAdded:Connect(onCharacterAdded)

